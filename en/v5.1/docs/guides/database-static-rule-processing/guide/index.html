<!--
 * Copyright (c) 2019, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 * WSO2 Inc. licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
-->





<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Cloud Native Stream Processor">
      
      
        <link rel="canonical" href="http://siddhi.io/en/v5.1/docs/guides/database-static-rule-processing/guide/">
      
      
        <meta name="author" content="WSO2">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Static Rule Processing using Database Rules - Siddhi</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../../assets/lib/highlightjs/default.min.css">
    
      <link rel="stylesheet" href="../../../../assets/css/theme.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-103065-28", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#static-rule-processing-via-predefined-and-database-based-rules" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
 * Copyright (c) 2019, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 * WSO2 Inc. licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
-->

<header class="md-header" data-md-component="header" id="page-header" data-url=""
        data-lang="en">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://siddhi.io/en/v5.1/" title="Siddhi"
           class="md-header-nav__button md-logo">
          
            <img src="../../../../images/siddhi-logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Siddhi
            </span>
            <span class="md-header-nav__topic">
              Static Rule Processing using Database Rules
            </span>
          
        </div>
        <div class="md-flex__ellipsis md-header__version-select">
            <div class="mb-tabs__dropdown version-select">
                <a class="md-tabs__link md-tabs__dropdown-link" href="#!" data-target="version-select-dropdown">
                  v5.1</a>
                <ul id="version-select-dropdown" class="mb-tabs__dropdown-content" tabindex="0">
                    <!-- Versions will added here dynamically -->
                    <li class="md-tabs__item mb-tabs__dropdown">
                        <a href="#" id="show-all-versions-link">Show all</a>
                    </li>
                </ul>
            </div>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          


  

<a href="https://github.com/siddhi-io/siddhi/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Siddhi
  </div>
</a>
        </div>
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
        <li class="md-tabs__item home_icon">
            <a href="/" title="Siddhi Home" class="md-tabs__link md-tabs__link--active">
                <i class="fa fa-home"></i>
            </a>
        </li>
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../download/" title="Download" class="md-tabs__link">
          Download
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../quick-start/" title="Quick Start" class="md-tabs__link">
          Quick Start
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../" title="Documentation" class="md-tabs__link md-tabs__link--active">
          Documentation
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="/community/" title="Community" class="md-tabs__link">
          Community
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../development/" title="Development" class="md-tabs__link">
          Development
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="/license/" title="License" class="md-tabs__link">
          License
        </a>
      
    </li>
  

      
    </ul>
    <div class="quick_links">
        
        <a href="https://github.com/siddhi-io/www/edit/v5.1/en/docs/docs/guides/database-static-rule-processing/guide.md" target="blank" id="editIcon" title="Edit this page"
           title="Edit this page" class="md-icon md-content__icon nav_link edit_link">Óèâ</a>
        
    </div>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
    <label class="md-nav__title md-nav__title--site" for="__drawer">
      <a href="http://siddhi.io/en/v5.1/" title="Siddhi"
         class="md-nav__button md-logo">
        
          <img src="../../../../images/siddhi-logo.svg" width="48" height="48">
        
      </a>
      Siddhi
    </label>
    
      <div class="md-nav__source">
        


  

<a href="https://github.com/siddhi-io/siddhi/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Siddhi
  </div>
</a>
      </div>
    
    <ul class="md-nav__list" data-md-scrollfix>
      
        
        
        


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Download
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Download
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../download/" title="Download" class="md-nav__link">
      Download
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../extensions/" title="Extensions" class="md-nav__link">
      Extensions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../release-notes/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

      
        
        
        


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Quick Start
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Quick Start
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../quick-start/" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

      
        
        
        

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../features/" title="Features" class="md-nav__link">
      Features
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../quick-start/" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4" checked>
    
    <label class="md-nav__link" for="nav-3-4">
      Use case Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Use case Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../alerts-for-thresholds/guide/" title="Alerts Based on Thresholds" class="md-nav__link">
      Alerts Based on Thresholds
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fault-tolerance/guide/" title="Fault Tolerance & Error Handling" class="md-nav__link">
      Fault Tolerance & Error Handling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../patterns-and-trends/guide/" title="Patterns & Trends Over Time" class="md-nav__link">
      Patterns & Trends Over Time
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Static Rule Processing using Database Rules
      </label>
    
    <a href="./" title="Static Rule Processing using Database Rules" class="md-nav__link md-nav__link--active">
      Static Rule Processing using Database Rules
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">On this page</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scenario-static-rule-processing" title="Scenario - Static Rule Processing" class="md-nav__link">
    Scenario - Static Rule Processing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-youll-build" title="What You'll Build" class="md-nav__link">
    What You'll Build
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mandatory-requirements" title="Mandatory Requirements" class="md-nav__link">
    Mandatory Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requirements-needed-to-deploy-siddhi-in-dockerkubernetes" title="Requirements needed to deploy Siddhi in Docker/Kubernetes" class="md-nav__link">
    Requirements needed to deploy Siddhi in Docker/Kubernetes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" title="Implementation" class="md-nav__link">
    Implementation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" title="Testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customer-table" title="Customer Table" class="md-nav__link">
    Customer Table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promo-card-table" title="Promo Card Table" class="md-nav__link">
    Promo Card Table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promo-card-rule-table" title="Promo Card Rule Table" class="md-nav__link">
    Promo Card Rule Table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promo-card-type-table" title="Promo Card Type Table" class="md-nav__link">
    Promo Card Type Table
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment" title="Deployment" class="md-nav__link">
    Deployment
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-on-vm-bare-metal" title="Deploy on VM/ Bare Metal" class="md-nav__link">
    Deploy on VM/ Bare Metal
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-on-docker" title="Deploy on Docker" class="md-nav__link">
    Deploy on Docker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisite" title="Prerequisite" class="md-nav__link">
    Prerequisite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#siddhi-docker-configurations" title="Siddhi Docker Configurations" class="md-nav__link">
    Siddhi Docker Configurations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-on-kubernetes" title="Deploy on Kubernetes" class="md-nav__link">
    Deploy on Kubernetes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#siddhi-kubernetes-configurations" title="Siddhi Kubernetes Configurations" class="md-nav__link">
    Siddhi Kubernetes Configurations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../integrate-various-enterprise-systems/guide/" title="Integrate Various Enterprise Systems" class="md-nav__link">
      Integrate Various Enterprise Systems
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../realtime-movie-recommendation/guide/" title="Realtime predictions with pre-trained ML models" class="md-nav__link">
      Realtime predictions with pre-trained ML models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../long-term-aggregation/guide/" title="Long-running time based Aggregations" class="md-nav__link">
      Long-running time based Aggregations
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tooling/" title="Tooling" class="md-nav__link">
      Tooling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../query-guide/" title="Query Guide" class="md-nav__link">
      Query Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-7" type="checkbox" id="nav-3-7">
    
    <label class="md-nav__link" for="nav-3-7">
      Siddhi APIs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-7">
        Siddhi APIs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../api/latest/" title="latest" class="md-nav__link">
      latest
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../api/5.1.0/" title="5.1.0" class="md-nav__link">
      5.1.0
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-8" type="checkbox" id="nav-3-8">
    
    <label class="md-nav__link" for="nav-3-8">
      REST API Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-8">
        REST API Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../rest-guides/siddhi-app-api/" title="Siddhi App APIs" class="md-nav__link">
      Siddhi App APIs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../rest-guides/on-demand-query-api/" title="On-Demand Query APIs" class="md-nav__link">
      On-Demand Query APIs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../rest-guides/health-check-api/" title="Health Check APIs" class="md-nav__link">
      Health Check APIs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../rest-guides/store-api/" title="Store APIs (Deprecated)" class="md-nav__link">
      Store APIs (Deprecated)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../rest-guides/default-ports/" title="Default Ports" class="md-nav__link">
      Default Ports
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../rest-guides/http-status-code/" title="HTTP Status Codes" class="md-nav__link">
      HTTP Status Codes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../extensions/" title="Extensions" class="md-nav__link">
      Extensions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../siddhi-as-a-java-library/" title="Siddhi Java Library" class="md-nav__link">
      Siddhi Java Library
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../siddhi-as-a-local-microservice/" title="Siddhi Local Microservice" class="md-nav__link">
      Siddhi Local Microservice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../siddhi-as-a-docker-microservice/" title="Siddhi Docker Microservice" class="md-nav__link">
      Siddhi Docker Microservice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../siddhi-as-a-kubernetes-microservice/" title="Siddhi Kubernetes Microservice" class="md-nav__link">
      Siddhi Kubernetes Microservice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../siddhi-as-a-python-library/" title="Siddhi Python Library" class="md-nav__link">
      Siddhi Python Library
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../config-guide/" title="Configuration Guide" class="md-nav__link">
      Configuration Guide
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

      
        
        
        


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Community
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Community
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="/community/" title="Community" class="md-nav__link">
      Community
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

      
        
        
        


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Development
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Development
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../development/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../development/source/" title="Source" class="md-nav__link">
      Source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../development/build/" title="Build" class="md-nav__link">
      Build
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../development/architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../development/roadmap/" title="Roadmap" class="md-nav__link">
      Roadmap
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

      
        
        
        


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      License
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        License
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="/license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

      
    </ul>
  </nav>  
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">On this page</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scenario-static-rule-processing" title="Scenario - Static Rule Processing" class="md-nav__link">
    Scenario - Static Rule Processing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-youll-build" title="What You'll Build" class="md-nav__link">
    What You'll Build
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mandatory-requirements" title="Mandatory Requirements" class="md-nav__link">
    Mandatory Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requirements-needed-to-deploy-siddhi-in-dockerkubernetes" title="Requirements needed to deploy Siddhi in Docker/Kubernetes" class="md-nav__link">
    Requirements needed to deploy Siddhi in Docker/Kubernetes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation" title="Implementation" class="md-nav__link">
    Implementation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" title="Testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customer-table" title="Customer Table" class="md-nav__link">
    Customer Table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promo-card-table" title="Promo Card Table" class="md-nav__link">
    Promo Card Table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promo-card-rule-table" title="Promo Card Rule Table" class="md-nav__link">
    Promo Card Rule Table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#promo-card-type-table" title="Promo Card Type Table" class="md-nav__link">
    Promo Card Type Table
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment" title="Deployment" class="md-nav__link">
    Deployment
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-on-vm-bare-metal" title="Deploy on VM/ Bare Metal" class="md-nav__link">
    Deploy on VM/ Bare Metal
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-on-docker" title="Deploy on Docker" class="md-nav__link">
    Deploy on Docker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisite" title="Prerequisite" class="md-nav__link">
    Prerequisite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#siddhi-docker-configurations" title="Siddhi Docker Configurations" class="md-nav__link">
    Siddhi Docker Configurations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-on-kubernetes" title="Deploy on Kubernetes" class="md-nav__link">
    Deploy on Kubernetes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#siddhi-kubernetes-configurations" title="Siddhi Kubernetes Configurations" class="md-nav__link">
    Siddhi Kubernetes Configurations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
  
                
                  <a href="https://github.com/siddhi-io/www/edit/v5.1/en/docs/docs/guides/database-static-rule-processing/guide.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="static-rule-processing-via-predefined-and-database-based-rules">Static Rule Processing via Predefined and Database Based Rules<a class="headerlink" href="#static-rule-processing-via-predefined-and-database-based-rules" title="Permanent link">&para;</a></h1>
<p>In this guide, we are going to explore how to process static rules stored in a database and make a decision according to those stored rules.</p>
<h2 id="scenario-static-rule-processing">Scenario - Static Rule Processing<a class="headerlink" href="#scenario-static-rule-processing" title="Permanent link">&para;</a></h2>
<p>After completing this scenario, you will be able to implement a system capable of making decisions according to a set of static rules. The static rules will be stored in a relational database(MySQL). You can dynamically change the rules in the database according to your business requirements without touching the deployed system. All the dynamic values need for each rule can be templated and pump into the rule at runtime.</p>
<h2 id="what-youll-build">What You'll Build<a class="headerlink" href="#what-youll-build" title="Permanent link">&para;</a></h2>
<p>The implementation of this use case explains using the functional requirements of the Combo supermart. Combo supermart is a supermarket that resides in our town. This Combo supermarket gives a loyalty card for their frequent customers. Each loyalty card has a type. These card types are Platinum, Gold, and Silver, etc. In each season management of the combo supermart planning to give discounts for each loyalty card. The percentage of the discount will change according to the type of loyalty card. Moreover, each loyalty card will select to have these discounts if that loyalty card fulfills several requirements. Those requirements are stored in a database as rules. These rules can be changed from time to time. Since combo supermart has to handle thousands of customer transaction per day in this season they cannot calculate these discounts in a manual process. Hence they planning to build an automatic system to calculate these discounts.</p>
<p>As shown in the following diagram the business process has to execute using six steps.</p>
<ol>
<li>A user sends an HTTP request with a JSON payload that contained an ID of a promo card and the amount of the transaction.</li>
<li>That JSON payload will consume by the HTTP service. Then parse the mapped values to the processing logic of the Siddhi query.</li>
<li>Initially, processing logic inputs the promo card ID to the MySQL database.</li>
<li>And retrieves all the rules relevant to the given promo card type.</li>
<li>After that process these rules and send output to the HTTP service response.</li>
<li>The HTTP service response will send back another JSON payload which indicating, whether this user allowed to have a discount or not. If this user allowed to have a discount then what is the percentage of the discount.</li>
</ol>
<p><img alt="Architecture Diagram" src="../images/architecture-diagram.png" title="Architecture Diagram" /></p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<h3 id="mandatory-requirements">Mandatory Requirements<a class="headerlink" href="#mandatory-requirements" title="Permanent link">&para;</a></h3>
<ol>
<li>Siddhi tooling <a href="https://siddhi.io/en/v5.1/download/">VM/Local distribution</a></li>
<li>One of the <a href="https://siddhi.io/en/v5.1/download/">Siddhi runner distributions</a><ol>
<li>VM/Local Runtime</li>
<li>Docker Image</li>
<li>K8S Operator (commands are given in Kubernetes deployment section)</li>
</ol>
</li>
<li><a href="https://www.mysql.com/">MySQL database</a></li>
<li><a href="https://www.oracle.com/java/technologies/jdk8-downloads.html">Java 8</a> or higher</li>
</ol>
<h3 id="requirements-needed-to-deploy-siddhi-in-dockerkubernetes">Requirements needed to deploy Siddhi in Docker/Kubernetes<a class="headerlink" href="#requirements-needed-to-deploy-siddhi-in-dockerkubernetes" title="Permanent link">&para;</a></h3>
<ol>
<li><a href="https://docs.docker.com/install/">Docker</a></li>
<li>Kubernetes cluster<ol>
<li><a href="https://github.com/kubernetes/minikube#installation">Minikube</a></li>
<li><a href="https://console.cloud.google.com">Google Kubernetes Engine(GKE)</a></li>
<li><a href="https://docs.docker.com/docker-for-mac/install/">Docker for Mac</a></li>
</ol>
</li>
<li>Refer to <a href="https://github.com/siddhi-io/siddhi-operator/blob/master/docs/gke-setup.md">this documentation about Configuring a Google Kubernetes Engine (GKE) Cluster</a> to deploy Siddhi apps in GKE.</li>
</ol>
<h2 id="implementation">Implementation<a class="headerlink" href="#implementation" title="Permanent link">&para;</a></h2>
<p>First of all, we assume that the Combo supermart has a MySQL database that contained the all promo card and user details. The following ER diagram describes the schema of the database.</p>
<p><img alt="ER Diagram" src="../images/er-diagram.png" title="ER Diagram" /></p>
<p>Now, you have to start the Siddhi tooling editor before implementing the Siddhi app. Siddhi tooling editor is an IDE that supports to implement Siddhi apps.</p>
<ol>
<li>First, you can download the Siddhi tooling pack as a zip file from <a href="https://siddhi.io/en/v5.1/download/">here</a> and extract it.</li>
<li>
<p>After creating the above database we need to have a mechanism to connect this database to Siddhi runtime. To do that you have to update the Siddhi tooling configuration file. Siddhi tooling configuration file is <code>&lt;TOOLING_HOME&gt;/conf/tooling/deployment.yaml</code>. You have to add the following YAML block under the dataSources entry in the deployment.yaml. The following YAML block contained all the details that need to connect to the database. For example, database username, password, and URL, etc.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">COMBO_SUPERMART_DB</span>
  <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">The datasource used for lending process of the Combo supermarket</span>
  <span class="nt">jndiConfig</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc/ComboSuperMart</span>
  <span class="nt">definition</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RDBMS</span>
    <span class="nt">configuration</span><span class="p">:</span>
      <span class="nt">jdbcUrl</span><span class="p">:</span> <span class="s">&#39;jdbc:mysql://127.0.0.1:3306/ComboSuperMart&#39;</span>
      <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhi_user</span>
      <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhiio</span>
      <span class="nt">driverClassName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.mysql.jdbc.Driver</span>
      <span class="nt">maxPoolSize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
      <span class="nt">idleTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60000</span>
      <span class="nt">connectionTestQuery</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SELECT 1</span>
      <span class="nt">validationTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30000</span>
      <span class="nt">isAutoCommit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</td></tr></table>

</li>
<li>
<p>In order to connect to a MySQL server Siddhi tooling needs the MySQL connector JAR. You can download the MySQL connector JAR from <a href="https://dev.mysql.com/downloads/connector/j/5.1.html">here</a> and copy that JAR into <code>&lt;TOOLING_HOME&gt;/jars</code> directory.</p>
</li>
<li>Start the following binary file. Using this link http://localhost:9390/editor now you can access the Siddhi tooling editor from your web browser.<ol>
<li>For Linux/Mac: <code>&lt;TOOLING_HOME&gt;/bin/tooling.sh</code></li>
<li>For Windows: <code>&lt;TOOLING_HOME&gt;/bin/tooling.bat</code></li>
</ol>
</li>
<li>Select <code>File -&gt; New</code> option, then you could either use the source view or design view to write/build the Siddhi Application. You can find the Siddhi Application bellow, that implements the requirements mentioned above.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Siddhi Query Guide</p>
<p>The execution steps and the logic of the Siddhi query described as comments in the following Siddhi app. Therefore here we are not going to explain in detail here. For more details about Siddhi queries please refer <a href="https://siddhi.io/en/v5.1/docs/query-guide/">Siddhi query guide</a>.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">@</span><span class="n">App</span><span class="p">:</span><span class="n">name</span><span class="p">(</span><span class="ss">&quot;ComboSuperMartPromoProcess&quot;</span><span class="p">)</span>
<span class="o">@</span><span class="n">App</span><span class="p">:</span><span class="n">description</span><span class="p">(</span><span class="ss">&quot;The promotion selection process of Combo super mart.&quot;</span><span class="p">)</span>


<span class="cm">/*</span>
<span class="cm">Purpose:</span>
<span class="cm">    The combo supermart has multiple promotion cards that given to their loyal users. For a particular season combo supermart plan to give discounts for each card. These discounts will change according to the card type and several rules. So, the combo supermart needed an automatic system to retrieve the discounts for a given card. To do that we implement this Siddhi app which interacts with a MySQL database and executes their functionalities. All card details and rules were stored in a MySQL database. All the rules for a particular card were in the templated format. Therefore all rules executed dynamically and give the final result.</span>

<span class="cm">Input:</span>
<span class="cm">        HTTP POST with JSON payload {</span>
<span class="cm">        &quot;event&quot;: {</span>
<span class="cm">            &quot;promoCardId&quot;: &quot;PC001&quot;,</span>
<span class="cm">            &quot;amount&quot;: 20000</span>
<span class="cm">          }</span>
<span class="cm">        }</span>

<span class="cm">Output:</span>
<span class="cm">    {</span>
<span class="cm">    &quot;event&quot;: {</span>
<span class="cm">        &quot;messageId&quot;: &quot;1817d06b-22ae-438e-990d-42fedcb50607&quot;,</span>
<span class="cm">        &quot;discountAmount&quot;: 15.0,</span>
<span class="cm">        &quot;discountApplied&quot;: true</span>
<span class="cm">    }</span>
<span class="cm">}</span>

<span class="cm">*/</span>
<span class="c1">-- HTTP source</span>
<span class="o">@</span><span class="k">source</span><span class="p">(</span>
    <span class="k">type</span><span class="o">=</span><span class="s1">&#39;http-service&#39;</span><span class="p">,</span>
    <span class="k">source</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;adder&#39;</span><span class="p">,</span>
    <span class="n">receiver</span><span class="p">.</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://0.0.0.0:8088/comboSuperMart/promo&#39;</span><span class="p">,</span>
    <span class="n">basic</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">enabled</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="o">@</span><span class="k">map</span><span class="p">(</span><span class="k">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">attributes</span><span class="p">(</span><span class="n">messageId</span><span class="o">=</span><span class="s1">&#39;trp:messageId&#39;</span><span class="p">,</span> <span class="n">promoCardId</span><span class="o">=</span><span class="s1">&#39;$.event.promoCardId&#39;</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="s1">&#39;$.event.amount&#39;</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">define</span> <span class="n">stream</span> <span class="n">InputTransactionStream</span><span class="p">(</span><span class="n">messageId</span> <span class="n">string</span><span class="p">,</span> <span class="n">promoCardId</span> <span class="n">string</span><span class="p">,</span> <span class="n">amount</span> <span class="n">long</span><span class="p">);</span>

<span class="c1">-- RDBMS data stores</span>
<span class="o">@</span><span class="n">Store</span><span class="p">(</span><span class="k">type</span><span class="o">=</span><span class="ss">&quot;rdbms&quot;</span><span class="p">,</span> <span class="n">datasource</span><span class="o">=</span><span class="ss">&quot;COMBO_SUPERMART_DB&quot;</span><span class="p">)</span>
<span class="n">define</span> <span class="k">table</span> <span class="n">Customer</span><span class="p">(</span><span class="n">customerId</span> <span class="n">string</span><span class="p">,</span> <span class="n">promoCardId</span> <span class="n">string</span><span class="p">);</span>
<span class="o">@</span><span class="n">Store</span><span class="p">(</span><span class="k">type</span><span class="o">=</span><span class="ss">&quot;rdbms&quot;</span><span class="p">,</span> <span class="n">datasource</span><span class="o">=</span><span class="ss">&quot;COMBO_SUPERMART_DB&quot;</span><span class="p">)</span>
<span class="n">define</span> <span class="k">table</span> <span class="n">PromoCard</span><span class="p">(</span><span class="n">promoCardId</span> <span class="n">string</span><span class="p">,</span> <span class="n">promoCardTypeId</span> <span class="n">string</span><span class="p">,</span> <span class="n">promoCardIssueDate</span> <span class="n">string</span><span class="p">);</span>
<span class="o">@</span><span class="n">Store</span><span class="p">(</span><span class="k">type</span><span class="o">=</span><span class="ss">&quot;rdbms&quot;</span><span class="p">,</span> <span class="n">datasource</span><span class="o">=</span><span class="ss">&quot;COMBO_SUPERMART_DB&quot;</span><span class="p">)</span>
<span class="n">define</span> <span class="k">table</span> <span class="n">PromoRule</span><span class="p">(</span><span class="n">promoRuleId</span> <span class="n">string</span><span class="p">,</span> <span class="n">promoCardTypeId</span> <span class="n">string</span><span class="p">,</span> <span class="n">promoRule</span> <span class="n">string</span><span class="p">);</span>
<span class="o">@</span><span class="n">Store</span><span class="p">(</span><span class="k">type</span><span class="o">=</span><span class="ss">&quot;rdbms&quot;</span><span class="p">,</span> <span class="n">datasource</span><span class="o">=</span><span class="ss">&quot;COMBO_SUPERMART_DB&quot;</span><span class="p">)</span>
<span class="n">define</span> <span class="k">table</span> <span class="n">PromoCardType</span><span class="p">(</span><span class="n">promoCardTypeId</span> <span class="n">string</span><span class="p">,</span> <span class="n">promoCardTypeDiscount</span> <span class="n">double</span><span class="p">);</span>

<span class="c1">-- Output stream</span>
<span class="o">@</span><span class="n">sink</span><span class="p">(</span><span class="k">type</span><span class="o">=</span><span class="s1">&#39;http-service-response&#39;</span><span class="p">,</span> <span class="k">source</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;adder&#39;</span><span class="p">,</span>
      <span class="n">message</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;{{messageId}}&#39;</span><span class="p">,</span> <span class="o">@</span><span class="k">map</span><span class="p">(</span><span class="k">type</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span><span class="p">))</span>
<span class="n">define</span> <span class="n">stream</span> <span class="n">ResultStream</span> <span class="p">(</span><span class="n">messageId</span> <span class="n">string</span><span class="p">,</span> <span class="n">discountAmount</span> <span class="n">double</span><span class="p">,</span> <span class="n">discountApplied</span> <span class="n">bool</span><span class="p">);</span>

<span class="c1">-- Find and execute rules</span>
<span class="o">@</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get-promocard-type&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">InputTransactionStream</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="k">length</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">join</span> <span class="n">PromoCard</span> <span class="k">on</span> <span class="n">InputTransactionStream</span><span class="p">.</span><span class="n">promoCardId</span><span class="o">==</span><span class="n">PromoCard</span><span class="p">.</span><span class="n">promoCardId</span>
<span class="k">select</span> <span class="n">InputTransactionStream</span><span class="p">.</span><span class="n">messageId</span><span class="p">,</span> <span class="n">InputTransactionStream</span><span class="p">.</span><span class="n">promoCardId</span><span class="p">,</span> <span class="n">PromoCard</span><span class="p">.</span><span class="n">promoCardTypeId</span><span class="p">,</span> <span class="n">PromoCard</span><span class="p">.</span><span class="n">promoCardIssueDate</span><span class="p">,</span> <span class="n">InputTransactionStream</span><span class="p">.</span><span class="n">amount</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">GetPromoCardTypeStream</span><span class="p">;</span>

<span class="o">@</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get-promocard-type-details&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">GetPromoCardTypeStream</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="k">length</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">join</span> <span class="n">PromoCardType</span> <span class="k">on</span> <span class="n">GetPromoCardTypeStream</span><span class="p">.</span><span class="n">promoCardTypeId</span><span class="o">==</span><span class="n">PromoCardType</span><span class="p">.</span><span class="n">promoCardTypeId</span>
<span class="k">select</span> <span class="n">GetPromoCardTypeStream</span><span class="p">.</span><span class="n">messageId</span><span class="p">,</span> <span class="n">GetPromoCardTypeStream</span><span class="p">.</span><span class="n">promoCardId</span><span class="p">,</span> <span class="n">GetPromoCardTypeStream</span><span class="p">.</span><span class="n">promoCardTypeId</span><span class="p">,</span> <span class="n">GetPromoCardTypeStream</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">PromoCardType</span><span class="p">.</span><span class="n">promoCardTypeDiscount</span><span class="p">,</span> <span class="n">GetPromoCardTypeStream</span><span class="p">.</span><span class="n">promoCardIssueDate</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="p">;</span>

<span class="o">@</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get-promocard-rules&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="k">length</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">right</span> <span class="k">outer</span> <span class="k">join</span> <span class="n">PromoRule</span> <span class="k">on</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="p">.</span><span class="n">promoCardTypeId</span><span class="o">==</span><span class="n">PromoRule</span><span class="p">.</span><span class="n">promoCardTypeId</span>
<span class="k">select</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="p">.</span><span class="n">messageId</span><span class="p">,</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="p">.</span><span class="n">promoCardId</span><span class="p">,</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="p">.</span><span class="n">promoCardTypeId</span><span class="p">,</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="p">.</span><span class="n">promoCardTypeDiscount</span><span class="p">,</span> <span class="n">PromoRule</span><span class="p">.</span><span class="n">promoRuleId</span><span class="p">,</span> <span class="n">PromoRule</span><span class="p">.</span><span class="n">promoRule</span><span class="p">,</span> <span class="n">GetPromoCardTypeDetailsStream</span><span class="p">.</span><span class="n">promoCardIssueDate</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">RuleStream</span><span class="p">;</span>

<span class="o">@</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;execute-promocard-rules&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">RuleStream</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="k">length</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">select</span> <span class="n">RuleStream</span><span class="p">.</span><span class="n">messageId</span><span class="p">,</span> <span class="n">RuleStream</span><span class="p">.</span><span class="n">promoCardTypeDiscount</span><span class="p">,</span> <span class="n">js</span><span class="p">:</span><span class="n">eval</span><span class="p">(</span><span class="n">str</span><span class="p">:</span><span class="n">fillTemplate</span><span class="p">(</span><span class="n">RuleStream</span><span class="p">.</span><span class="n">promoRule</span><span class="p">,</span> <span class="k">map</span><span class="p">:</span><span class="k">create</span><span class="p">(</span><span class="ss">&quot;amount&quot;</span><span class="p">,</span> <span class="n">RuleStream</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="ss">&quot;cardPeriod&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span><span class="n">dateDiff</span><span class="p">(</span><span class="n">time</span><span class="p">:</span><span class="n">currentDate</span><span class="p">(),</span> <span class="n">RuleStream</span><span class="p">.</span><span class="n">promoCardIssueDate</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">,</span> <span class="s1">&#39;yyyy-MM-dd&#39;</span><span class="p">))),</span> <span class="s1">&#39;bool&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">result</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">RuleReslutsStream</span><span class="p">;</span>

<span class="c1">-- Output results</span>
<span class="o">@</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;filter-true-rules&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">RuleReslutsStream</span><span class="p">[</span><span class="k">result</span> <span class="o">==</span> <span class="k">true</span><span class="p">]</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="n">batch</span><span class="p">()</span>
<span class="k">select</span> <span class="n">RuleReslutsStream</span><span class="p">.</span><span class="n">messageId</span><span class="p">,</span> <span class="n">RuleReslutsStream</span><span class="p">.</span><span class="n">promoCardTypeDiscount</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="k">result</span><span class="p">)</span> <span class="k">as</span> <span class="k">result</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">TrueResultStream</span><span class="p">;</span>

<span class="o">@</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get-all-results&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">RuleReslutsStream</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="n">batch</span><span class="p">()</span>
<span class="k">select</span> <span class="n">RuleReslutsStream</span><span class="p">.</span><span class="n">messageId</span><span class="p">,</span> <span class="n">RuleReslutsStream</span><span class="p">.</span><span class="n">promoCardTypeDiscount</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="k">result</span><span class="p">)</span> <span class="k">as</span> <span class="k">result</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">AllResultStream</span><span class="p">;</span>

<span class="o">@</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;discout-reply-stream&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">AllResultStream</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="k">length</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="n">unidirectional</span> <span class="k">join</span>  <span class="n">TrueResultStream</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="k">length</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">on</span> <span class="n">TrueResultStream</span><span class="p">.</span><span class="k">result</span><span class="o">==</span><span class="n">AllResultStream</span><span class="p">.</span><span class="k">result</span>
<span class="k">select</span> <span class="n">AllResultStream</span><span class="p">.</span><span class="n">messageId</span><span class="p">,</span> <span class="n">AllResultStream</span><span class="p">.</span><span class="n">promoCardTypeDiscount</span> <span class="k">as</span> <span class="n">discountAmount</span><span class="p">,</span> <span class="k">true</span> <span class="k">as</span> <span class="n">discountApplied</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">ResultStream</span><span class="p">;</span>

<span class="o">@</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;filter-true-rules-and-reply&#39;</span><span class="p">)</span>
<span class="k">from</span> <span class="n">RuleReslutsStream</span><span class="p">[</span><span class="k">result</span> <span class="o">==</span> <span class="k">false</span><span class="p">]</span><span class="o">#</span><span class="n">window</span><span class="p">.</span><span class="n">batch</span><span class="p">()</span>
<span class="k">select</span> <span class="n">RuleReslutsStream</span><span class="p">.</span><span class="n">messageId</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="k">as</span> <span class="n">discountAmount</span><span class="p">,</span> <span class="k">false</span> <span class="k">as</span> <span class="n">discountApplied</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">ResultStream</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>The following flow diagram depicts the design view of the above Siddhi app.</p>
<p><img alt="Execution Process" src="../images/process-flow-diagram.png" title="Execution Process" /></p>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<p>Let‚Äôs run and test the above Siddhi app in your local machine. If you completed the implementation process correctly you will be able to start your Siddhi application without any error.</p>
<p>Before you run the application your database should have sample data to be processed. The following images show the sample data tables that we are using for this guide.</p>
<h3 id="customer-table">Customer Table<a class="headerlink" href="#customer-table" title="Permanent link">&para;</a></h3>
<p><img alt="Customer Table" src="../images/customer-table.png" title="Customer Table" /></p>
<h3 id="promo-card-table">Promo Card Table<a class="headerlink" href="#promo-card-table" title="Permanent link">&para;</a></h3>
<p><img alt="Promo Card Table" src="../images/promocard-table.png" title="Promo Card Table" /></p>
<h3 id="promo-card-rule-table">Promo Card Rule Table<a class="headerlink" href="#promo-card-rule-table" title="Permanent link">&para;</a></h3>
<p><img alt="Promo Card Rule Table" src="../images/promocard-rule-table.png" title="Promo Card Rule Table" /></p>
<h3 id="promo-card-type-table">Promo Card Type Table<a class="headerlink" href="#promo-card-type-table" title="Permanent link">&para;</a></h3>
<p><img alt="Promo Card Type Table" src="../images/promocard-type-table.png" title="Promo Card Type Table" /></p>
<p>The above Siddhi app will start an HTTP service in 8088 port. Therefore, you can send a request to that service using the following CURL command.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>curl -X POST <span class="se">\</span>
  http://0.0.0.0:8088/comboSuperMart/promo <span class="se">\</span>
  -H <span class="s1">&#39;Accept: */*&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Host: 0.0.0.0:8088&#39;</span> <span class="se">\</span>
  -d <span class="s1">&#39;{</span>
<span class="s1">  &quot;event&quot;: {</span>
<span class="s1">    &quot;promoCardId&quot;: &quot;PC001&quot;,</span>
<span class="s1">    &quot;amount&quot;: 10000</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</pre></div>
</td></tr></table>

<p>This request will response back the following JSON.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;messageId&quot;</span><span class="p">:</span> <span class="s2">&quot;8f38faea-9dbd-4387-b807-b9f170db20dd&quot;</span><span class="p">,</span>
        <span class="nt">&quot;discountAmount&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="nt">&quot;discountApplied&quot;</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="deployment">Deployment<a class="headerlink" href="#deployment" title="Permanent link">&para;</a></h2>
<h3 id="deploy-on-vm-bare-metal">Deploy on VM/ Bare Metal<a class="headerlink" href="#deploy-on-vm-bare-metal" title="Permanent link">&para;</a></h3>
<ol>
<li>First you have to setup MySQL as described earlier. Refer <a href="https://www.mysql.com/">this</a> link to setup MySQL.</li>
<li>Download the <a href="https://siddhi.io/en/v5.1/download/">Siddhi runner distribution pack from here</a> and unzip it.</li>
<li>
<p>Add following YAML block to the <code>&lt;RUNNER_HOME&gt;/conf/runner/deployment.yaml</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">COMBO_SUPERMART_DB</span>
  <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">The datasource used for lending process of the Combo supermarket</span>
  <span class="nt">jndiConfig</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc/ComboSuperMart</span>
  <span class="nt">definition</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RDBMS</span>
    <span class="nt">configuration</span><span class="p">:</span>
      <span class="nt">jdbcUrl</span><span class="p">:</span> <span class="s">&#39;jdbc:mysql://127.0.0.1:3306/ComboSuperMart&#39;</span>
      <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhi_user</span>
      <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhiio</span>
      <span class="nt">driverClassName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.mysql.jdbc.Driver</span>
      <span class="nt">maxPoolSize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
      <span class="nt">idleTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60000</span>
      <span class="nt">connectionTestQuery</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SELECT 1</span>
      <span class="nt">validationTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30000</span>
      <span class="nt">isAutoCommit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</td></tr></table>

</li>
<li>
<p>Download the MySQL connector JAR from <a href="https://dev.mysql.com/downloads/connector/j/5.1.html">here</a> and copy that JAR into <code>&lt;RUNNER_HOME&gt;/jars</code> directory.</p>
</li>
<li>Copy your Siddhi file into <code>&lt;RUNNER_HOME&gt;/wso2/runner/deployment/siddhi-files</code></li>
<li>Start the following binary file. Using this link http://localhost:9390/editor now you can access the Siddhi tooling editor from your web browser.<ol>
<li>For Linux/Mac: <code>&lt;RUNNER_HOME&gt;/bin/runner.sh</code></li>
<li>For Windows: <code>&lt;RUNNER_HOME&gt;/bin/runner.bat</code></li>
</ol>
</li>
</ol>
<p>Execute the following CURL command.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>curl -X POST <span class="se">\</span>
  http://0.0.0.0:8088/comboSuperMart/promo <span class="se">\</span>
  -H <span class="s1">&#39;Accept: */*&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Host: 0.0.0.0:8088&#39;</span> <span class="se">\</span>
  -d <span class="s1">&#39;{</span>
<span class="s1">  &quot;event&quot;: {</span>
<span class="s1">    &quot;promoCardId&quot;: &quot;PC001&quot;,</span>
<span class="s1">    &quot;amount&quot;: 10000</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</pre></div>
</td></tr></table>

<p>It will results the following JSON.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;messageId&quot;</span><span class="p">:</span> <span class="s2">&quot;8f38faea-9dbd-4387-b807-b9f170db20dd&quot;</span><span class="p">,</span>
        <span class="nt">&quot;discountAmount&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="nt">&quot;discountApplied&quot;</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="deploy-on-docker">Deploy on Docker<a class="headerlink" href="#deploy-on-docker" title="Permanent link">&para;</a></h3>
<h4 id="prerequisite">Prerequisite<a class="headerlink" href="#prerequisite" title="Permanent link">&para;</a></h4>
<p><a href="https://docs.docker.com/install/">Install Docker</a> into your machine.</p>
<h4 id="siddhi-docker-configurations">Siddhi Docker Configurations<a class="headerlink" href="#siddhi-docker-configurations" title="Permanent link">&para;</a></h4>
<p>In the tooling editor itself, you can export your Siddhi app into a runnable docker artifact. You can go to <code>Export-&gt;For Docker</code> and it will give to a zip file that contained the following files.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ configurations.yaml
‚îú‚îÄ‚îÄ jars
‚îÇ   ‚îî‚îÄ‚îÄ mysql-connector.jar
‚îî‚îÄ‚îÄ siddhi-files
    ‚îî‚îÄ‚îÄ ComboSuperMartPromoProcess.siddhi
</pre></div>
</td></tr></table>

<p>You also need to set up a MySQL docker container and connect it into the Siddhi docker runtime. You can do it very easily from writing a docker composer file like below.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&quot;3&quot;</span>
<span class="nt">services</span><span class="p">:</span>
    <span class="nt">backend</span><span class="p">:</span>
        <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">combosupermart-promo</span>
        <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">802:802</span>
        <span class="nt">build</span><span class="p">:</span>
          <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
          <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./Dockerfile</span>
        <span class="nt">ports</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&quot;8088:8088&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">links:Now you need to have a Docker compose file like below to set up all the prerequisites. This compose file contains volume mounts to change configurations of the MySQL container.</span>
            <span class="l l-Scalar l-Scalar-Plain">- mysqldb</span>
        <span class="nt">networks</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
        <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">on-failure</span>

    <span class="nt">mysqldb</span><span class="p">:</span>
        <span class="nt">image</span><span class="p">:</span> <span class="s">&#39;mysql:5.7&#39;</span>
        <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">combosupermart-db</span>
        <span class="nt">environment</span><span class="p">:</span>
            <span class="nt">MYSQL_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhi_user</span>
            <span class="nt">MYSQL_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhiio</span>
            <span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhiio</span>
        <span class="nt">ports</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&quot;3304:3306&quot;</span>
        <span class="nt">networks</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
        <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">on-failure</span>
</pre></div>
</td></tr></table>

<p>First, you have to build the docker composer.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker-compose build
</pre></div>
</td></tr></table>

<p>Now you have to start the MySQL container.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker-compose up -d mysqldb
</pre></div>
</td></tr></table>

<p>Now you can connect to the MySQL server using the following configurations.</p>
<ol>
<li>Host: 0.0.0.0</li>
<li>Port: 3304</li>
<li>Root user: root</li>
<li>Root password: siddhiio</li>
<li>Custom user: siddhi_user</li>
<li>Custom user password: siddhiio</li>
</ol>
<p>Then you can create the database schema in that MySQL container. After that, you can start the Siddhi runtime using the following command.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker-compose up -d backend
</pre></div>
</td></tr></table>

<p>To check the deployments up and running, send the following CURL request.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>curl -X POST <span class="se">\</span>
  http://0.0.0.0:8088/comboSuperMart/promo <span class="se">\</span>
  -H <span class="s1">&#39;Accept: */*&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Host: 0.0.0.0:8088&#39;</span> <span class="se">\</span>
  -d <span class="s1">&#39;{</span>
<span class="s1">  &quot;event&quot;: {</span>
<span class="s1">    &quot;promoCardId&quot;: &quot;PC001&quot;,</span>
<span class="s1">    &quot;amount&quot;: 20000</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</pre></div>
</td></tr></table>

<p>It will results the following JSON.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;messageId&quot;</span><span class="p">:</span> <span class="s2">&quot;285703c1-866a-4a88-8e1f-e75543e18373&quot;</span><span class="p">,</span>
        <span class="nt">&quot;discountAmount&quot;</span><span class="p">:</span> <span class="mf">15.0</span><span class="p">,</span>
        <span class="nt">&quot;discountApplied&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="deploy-on-kubernetes">Deploy on Kubernetes<a class="headerlink" href="#deploy-on-kubernetes" title="Permanent link">&para;</a></h3>
<h4 id="prerequisites_1">Prerequisites<a class="headerlink" href="#prerequisites_1" title="Permanent link">&para;</a></h4>
<ol>
<li>Kubernetes cluster<ol>
<li><a href="https://github.com/kubernetes/minikube#installation">Minikube</a></li>
<li><a href="https://console.cloud.google.com">Google Kubernetes Engine(GKE)</a></li>
<li><a href="https://docs.docker.com/docker-for-mac/install/">Docker for Mac</a></li>
</ol>
</li>
<li><a href="https://helm.sh/docs/using_helm/#installing-helm">Install HELM</a></li>
</ol>
<h4 id="siddhi-kubernetes-configurations">Siddhi Kubernetes Configurations<a class="headerlink" href="#siddhi-kubernetes-configurations" title="Permanent link">&para;</a></h4>
<p>In the tooling editor itself, you can export your Siddhi app into a runnable Kubernetes artifact. You can go to <code>Export-&gt;For Kubernetes</code> and it will give to a zip file that contained the following files.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ configurations.yaml
‚îú‚îÄ‚îÄ jars
‚îÇ   ‚îî‚îÄ‚îÄ mysql-connector.jar
‚îú‚îÄ‚îÄ siddhi-files
‚îÇ   ‚îî‚îÄ‚îÄ ComboSuperMartPromoProcess.siddhi.siddhi
‚îî‚îÄ‚îÄ siddhi-process.yaml
</pre></div>
</td></tr></table>

<p>First, you need to install the Siddhi Kubernetes operator using following commands. For more details about the Siddhi operator refer to <a href="https://siddhi.io/en/v5.1/docs/siddhi-as-a-kubernetes-microservice/#install-siddhi-operator">this documentation</a>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ kubectl apply -f https://github.com/siddhi-io/siddhi-operator/releases/download/v0.2.0/00-prereqs.yaml
$ kubectl apply -f https://github.com/siddhi-io/siddhi-operator/releases/download/v0.2.0/01-siddhi-operator.yaml
</pre></div>
</td></tr></table>

<p>Now you have to set up MySQL in your Kubernetes cluster. To do that use the following helm command.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ helm install --name mysql-db --set <span class="nv">mysqlRootPassword</span><span class="o">=</span>siddhiio,mysqlUser<span class="o">=</span>siddhi_user,mysqlPassword<span class="o">=</span>siddhiio,mysqlDatabase<span class="o">=</span>ComboSuperMart stable/mysql
</pre></div>
</td></tr></table>

<p>Then, you can set a port forwarding to the MySQL service which allows you to connect from the Host</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ kubectl port-forward svc/mysql-db <span class="m">3307</span>:3306
</pre></div>
</td></tr></table>

<p>Now you can access the MySQL cluster externally. Accessing MySQL cluster externally you can create ComboSuperMart database and the database schema. Using jdbc:mysql://mysql-db:3306/ComboSuperMart URL you can access the database.</p>
<div class="admonition note">
<p class="admonition-title">Database URL for Kubernetes</p>
<p>When you changing the <code>deployment.yaml</code> configuration of the data source in the Kubernetes export process, you have to specify this URL in the configuration as below.</p>
</div>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>   <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">COMBO_SUPERMART_DB</span>
     <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">The datasource used for lending process of the Combo supermarket</span>
     <span class="nt">jndiConfig</span><span class="p">:</span>
       <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc/ComboSuperMart</span>
     <span class="nt">definition</span><span class="p">:</span>
       <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RDBMS</span>
       <span class="nt">configuration</span><span class="p">:</span>
         <span class="nt">jdbcUrl</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc:mysql://mysql-db:3306/ComboSuperMart</span>
         <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhi_user</span>
         <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhiio</span>
         <span class="nt">driverClassName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.mysql.jdbc.Driver</span>
         <span class="nt">maxPoolSize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
         <span class="nt">idleTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60000</span>
         <span class="nt">connectionTestQuery</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SELECT 1</span>
         <span class="nt">validationTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30000</span>
         <span class="nt">isAutoCommit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</td></tr></table>

<p>Siddhi operator will automatically set up the external access to any HTTP service in a Siddhi app. To set up that external access Siddhi operator by default uses ingress NGINX. Set up the NGINX controller in your Kubernetes cluster as described in <a href="https://kubernetes.github.io/ingress-nginx/deploy/">this document</a>.</p>
<p>Now you need to create your own docker image with including all the custom libraries and configuration changes that you have made. Use following command to build and push the docker image with the tag <code>&lt;DOCKER_HUB_USER_NAME&gt;/siddhi-runner-alpine:latest</code>.</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker build -t &lt;DOCKER_HUB_USER_NAME&gt;/siddhi-runner-alpine:latest .
$ docker push &lt;DOCKER_HUB_USER_NAME&gt;/siddhi-runner-alpine:latest
</pre></div>
</td></tr></table>
After the Kubernetes export now you already have this <code>siddhi-process.yaml</code> file.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">siddhi.io/v1alpha2</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SiddhiProcess</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">combo-super-mart</span>

<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">apps</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">script</span><span class="p">:</span> <span class="p p-Indicator">|</span>
      <span class="no">@App:name(&quot;ComboSuperMartPromoProcess&quot;)</span>
      <span class="no">@App:description(&quot;The promotion selection process of Combo super mart.&quot;)</span>


      <span class="no">/*</span>
      <span class="no">Purpose:</span>
          <span class="no">The combo supermart has multiple promotion card that given to their loyal users. For a particular season combo supermart plan to give discounts for each card. These discounts will change according to the card type and several rules. So, combo supermart needed an automatic system to retrieve the discounts for a given card. To do that we implement this Siddhi app which interacts with a MySQL database and executes their functionalities. All card details and rules were stored in a MySQL database. All the rules for a particular card were in the templated format. Therefore all rules executed dynamically and give the final result.</span>

      <span class="no">Input:</span>
              <span class="no">HTTP POST with JSON payload {</span>
              <span class="no">&quot;event&quot;: {</span>
                  <span class="no">&quot;promoCardId&quot;: &quot;PC001&quot;,</span>
                  <span class="no">&quot;amount&quot;: 20000</span>
                <span class="no">}</span>
              <span class="no">}</span>

      <span class="no">Output:</span>
          <span class="no">{</span>
          <span class="no">&quot;event&quot;: {</span>
              <span class="no">&quot;messageId&quot;: &quot;1817d06b-22ae-438e-990d-42fedcb50607&quot;,</span>
              <span class="no">&quot;discountAmount&quot;: 15.0,</span>
              <span class="no">&quot;discountApplied&quot;: true</span>
          <span class="no">}</span>
      <span class="no">}</span>

      <span class="no">*/</span>
      <span class="no">-- HTTP source</span>
      <span class="no">@source(</span>
          <span class="no">type=&#39;http-service&#39;,</span>
          <span class="no">source.id=&#39;adder&#39;,</span>
          <span class="no">receiver.url=&#39;http://0.0.0.0:8088/comboSuperMart/promo&#39;,</span>
          <span class="no">basic.auth.enabled=&#39;&#39;,</span>
          <span class="no">@map(type=&#39;json&#39;, @attributes(messageId=&#39;trp:messageId&#39;, promoCardId=&#39;$.event.promoCardId&#39;, amount=&#39;$.event.amount&#39;))</span>
      <span class="no">)</span>
      <span class="no">define stream InputTransactionStream(messageId string, promoCardId string, amount long);</span>

      <span class="no">-- RDBMS data stores</span>
      <span class="no">@Store(type=&quot;rdbms&quot;, datasource=&quot;COMBO_SUPERMART_DB&quot;)</span>
      <span class="no">define table Customer(customerId string, promoCardId string);</span>
      <span class="no">@Store(type=&quot;rdbms&quot;, datasource=&quot;COMBO_SUPERMART_DB&quot;)</span>
      <span class="no">define table PromoCard(promoCardId string, promoCardTypeId string, promoCardIssueDate string);</span>
      <span class="no">@Store(type=&quot;rdbms&quot;, datasource=&quot;COMBO_SUPERMART_DB&quot;)</span>
      <span class="no">define table PromoRule(promoRuleId string, promoCardTypeId string, promoRule string);</span>
      <span class="no">@Store(type=&quot;rdbms&quot;, datasource=&quot;COMBO_SUPERMART_DB&quot;)</span>
      <span class="no">define table PromoCardType(promoCardTypeId string, promoCardTypeDiscount double);</span>

      <span class="no">-- Output stream</span>
      <span class="no">@sink(type=&#39;http-service-response&#39;, source.id=&#39;adder&#39;,</span>
            <span class="no">message.id=&#39;{{messageId}}&#39;, @map(type = &#39;json&#39;))</span>
      <span class="no">define stream ResultStream (messageId string, discountAmount double, discountApplied bool);</span>

      <span class="no">-- Find and execute rules</span>
      <span class="no">@info(name=&#39;get-promocard-type&#39;)</span>
      <span class="no">from InputTransactionStream#window.length(1) join PromoCard on InputTransactionStream.promoCardId==PromoCard.promoCardId</span>
      <span class="no">select InputTransactionStream.messageId, InputTransactionStream.promoCardId, PromoCard.promoCardTypeId, PromoCard.promoCardIssueDate, InputTransactionStream.amount</span>
      <span class="no">insert into GetPromoCardTypeStream;</span>

      <span class="no">@info(name=&#39;get-promocard-type-details&#39;)</span>
      <span class="no">from GetPromoCardTypeStream#window.length(1) join PromoCardType on GetPromoCardTypeStream.promoCardTypeId==PromoCardType.promoCardTypeId</span>
      <span class="no">select GetPromoCardTypeStream.messageId, GetPromoCardTypeStream.promoCardId, GetPromoCardTypeStream.promoCardTypeId, GetPromoCardTypeStream.amount, PromoCardType.promoCardTypeDiscount, GetPromoCardTypeStream.promoCardIssueDate</span>
      <span class="no">insert into GetPromoCardTypeDetailsStream;</span>

      <span class="no">@info(name=&#39;get-promocard-rules&#39;)</span>
      <span class="no">from GetPromoCardTypeDetailsStream#window.length(1) right outer join PromoRule on GetPromoCardTypeDetailsStream.promoCardTypeId==PromoRule.promoCardTypeId</span>
      <span class="no">select GetPromoCardTypeDetailsStream.messageId, GetPromoCardTypeDetailsStream.promoCardId, GetPromoCardTypeDetailsStream.promoCardTypeId, GetPromoCardTypeDetailsStream.amount, GetPromoCardTypeDetailsStream.promoCardTypeDiscount, PromoRule.promoRuleId, PromoRule.promoRule, GetPromoCardTypeDetailsStream.promoCardIssueDate</span>
      <span class="no">insert into RuleStream;</span>

      <span class="no">@info(name=&#39;execute-promocard-rules&#39;)</span>
      <span class="no">from RuleStream#window.length(1)</span>
      <span class="no">select RuleStream.messageId, RuleStream.promoCardTypeDiscount, js:eval(str:fillTemplate(RuleStream.promoRule, map:create(&quot;amount&quot;, RuleStream.amount, &quot;cardPeriod&quot;, time:dateDiff(time:currentDate(), RuleStream.promoCardIssueDate, &#39;yyyy-MM-dd&#39;, &#39;yyyy-MM-dd&#39;))), &#39;bool&#39;) as result</span>
      <span class="no">insert into RuleReslutsStream;</span>

      <span class="no">-- Output results</span>
      <span class="no">@info(name=&#39;filter-true-rules&#39;)</span>
      <span class="no">from RuleReslutsStream[result == true]#window.batch()</span>
      <span class="no">select RuleReslutsStream.messageId, RuleReslutsStream.promoCardTypeDiscount, count(result) as result</span>
      <span class="no">insert into TrueResultStream;</span>

      <span class="no">@info(name=&#39;get-all-results&#39;)</span>
      <span class="no">from RuleReslutsStream#window.batch()</span>
      <span class="no">select RuleReslutsStream.messageId, RuleReslutsStream.promoCardTypeDiscount, count(result) as result</span>
      <span class="no">insert into AllResultStream;</span>

      <span class="no">@info(name=&#39;discout-reply-stream&#39;)</span>
      <span class="no">from AllResultStream#window.length(1) unidirectional join  TrueResultStream#window.length(1) on TrueResultStream.result==AllResultStream.result</span>
      <span class="no">select AllResultStream.messageId, AllResultStream.promoCardTypeDiscount as discountAmount, true as discountApplied</span>
      <span class="no">insert into ResultStream;</span>

      <span class="no">@info(name=&#39;filter-true-rules-and-reply&#39;)</span>
      <span class="no">from RuleReslutsStream[result == false]#window.batch()</span>
      <span class="no">select RuleReslutsStream.messageId, 0.00 as discountAmount, false as discountApplied</span>
      <span class="no">insert into ResultStream;</span>
  <span class="nt">runner</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">wso2.carbon:</span>
      <span class="no">id: siddhi-runner</span>
      <span class="no">name: Siddhi Runner Distribution</span>
      <span class="no">ports:</span>
        <span class="no">offset: 0</span>
    <span class="no">transports:</span>
      <span class="no">http:</span>
        <span class="no">listenerConfigurations:</span>
        <span class="no">- id: default</span>
          <span class="no">host: 0.0.0.0</span>
          <span class="no">port: 9090</span>
        <span class="no">- id: msf4j-https</span>
          <span class="no">host: 0.0.0.0</span>
          <span class="no">port: 9443</span>
          <span class="no">scheme: https</span>
          <span class="no">keyStoreFile: ${carbon.home}/resources/security/wso2carbon.jks</span>
          <span class="no">keyStorePassword: wso2carbon</span>
          <span class="no">certPass: wso2carbon</span>
        <span class="no">transportProperties:</span>
        <span class="no">- name: server.bootstrap.socket.timeout</span>
          <span class="no">value: 60</span>
        <span class="no">- name: client.bootstrap.socket.timeout</span>
          <span class="no">value: 60</span>
        <span class="no">- name: latency.metrics.enabled</span>
          <span class="no">value: true</span>
    <span class="no">dataSources:</span>
    <span class="no">- name: WSO2_CARBON_DB</span>
      <span class="no">description: The datasource used for registry and user manager</span>
      <span class="no">definition:</span>
        <span class="no">type: RDBMS</span>
        <span class="no">configuration:</span>
          <span class="no">jdbcUrl: jdbc:h2:${sys:carbon.home}/wso2/${sys:wso2.runtime}/database/WSO2_CARBON_DB;DB_CLOSE_ON_EXIT=FALSE;LOCK_TIMEOUT=60000</span>
          <span class="no">username: wso2carbon</span>
          <span class="no">password: wso2carbon</span>
          <span class="no">driverClassName: org.h2.Driver</span>
          <span class="no">maxPoolSize: 10</span>
          <span class="no">idleTimeout: 60000</span>
          <span class="no">connectionTestQuery: SELECT 1</span>
          <span class="no">validationTimeout: 30000</span>
          <span class="no">isAutoCommit: false</span>
    <span class="no">- name: COMBO_SUPERMART_DB</span>
      <span class="no">description: The datasource used for lending process of the Combo supermarket</span>
      <span class="no">jndiConfig:</span>
        <span class="no">name: jdbc/ComboSuperMart</span>
      <span class="no">definition:</span>
        <span class="no">type: RDBMS</span>
        <span class="no">configuration:</span>
          <span class="no">jdbcUrl: jdbc:mysql://mysql-db:3306/ComboSuperMart</span>
          <span class="no">username: siddhi_user</span>
          <span class="no">password: siddhiio</span>
          <span class="no">driverClassName: com.mysql.jdbc.Driver</span>
          <span class="no">maxPoolSize: 10</span>
          <span class="no">idleTimeout: 60000</span>
          <span class="no">connectionTestQuery: SELECT 1</span>
          <span class="no">validationTimeout: 30000</span>
          <span class="no">isAutoCommit: false</span>

  <span class="nt">persistentVolumeClaim</span><span class="p">:</span> 
    <span class="nt">accessModes</span><span class="p">:</span> 
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
    <span class="nt">resources</span><span class="p">:</span> 
      <span class="nt">requests</span><span class="p">:</span> 
        <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
    <span class="nt">storageClassName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">standard</span>
    <span class="nt">volumeMode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Filesystem</span>

  <span class="nt">container</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;DOCKER_HUB_USER_NAME&gt;/siddhi-runner-alpine:latest</span>
</pre></div>
</td></tr></table>

<p>Now you can install the SiddhiProcess using following <code>kubectl</code> command. Before you install the <code>SiddhiProcess</code> you have to add the docker image tag in the <code>siddhi-process.yaml</code> file. You have to add the docker image name(<code>&lt;DOCKER_HUB_USER_NAME&gt;/siddhi-runner-alpine:latest</code>) in the YAML entry <code>spec.container.image</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ kubectl apply -f siddhi-process.yaml
</pre></div>
</td></tr></table>

<p>The ingress created by Siddhi operator will use the hostname as siddhi. Therefore you have to update your <code>/etc/host</code> file with siddhi hostname along with the external IP of ingress.</p>
<div class="admonition note">
<p class="admonition-title">External IP of Ingress</p>
<p>For minikube the ingress external IP is minikube IP and in docker, for Mac, the external IP is 0.0.0.0. For more details about Siddhi, ingress setup refer to <a href="https://siddhi.io/en/v5.1/docs/siddhi-as-a-kubernetes-microservice/">this documentation</a>.</p>
</div>
<p>Now you can send HTTP requests to deployed the Siddhi app in the Kubernetes cluster using following CURL command.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>curl -X POST <span class="se">\</span>
  http://siddhi/combo-super-mart-0/8088/comboSuperMart/promo <span class="se">\</span>
  -H <span class="s1">&#39;Accept: */*&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Accept-Encoding: gzip, deflate&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
  -H <span class="s1">&#39;Host: siddhi&#39;</span> <span class="se">\</span>
  -d <span class="s1">&#39;{</span>
<span class="s1">  &quot;event&quot;: {</span>
<span class="s1">    &quot;promoCardId&quot;: &quot;PC001&quot;,</span>
<span class="s1">    &quot;amount&quot;: 20000</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</pre></div>
</td></tr></table>

<p>It will results the following JSON.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;messageId&quot;</span><span class="p">:</span> <span class="s2">&quot;285703c1-866a-4a88-8e1f-e75543e18374&quot;</span><span class="p">,</span>
        <span class="nt">&quot;discountAmount&quot;</span><span class="p">:</span> <span class="mf">15.0</span><span class="p">,</span>
        <span class="nt">&quot;discountApplied&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
                
                  
                
              
  <a href="#" class="cd-top text--replace js-cd-top">Top</a>

              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../patterns-and-trends/guide/" title="Patterns & Trends Over Time" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Patterns & Trends Over Time
              </span>
            </div>
          </a>
        
        
          <a href="../../integrate-various-enterprise-systems/guide/" title="Integrate Various Enterprise Systems" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Integrate Various Enterprise Systems
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Siddhi - Documentation
          </div>
        
        &copy;2019 <a href="https://wso2.com/">WSO2</a>
      </div>
      
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../../assets/fonts/font-awesome.css">
    
      <a href="/community/#community-collaboration" class="md-footer-social__link fa fa-slack"></a>
    
      <a href="https://github.com/siddhi-io/siddhi" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://medium.com/siddhi-io" class="md-footer-social__link fa fa-medium"></a>
    
      <a href="https://twitter.com/siddhi_io" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/groups/13553064" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
        <script src="../../../../assets/lib/highlightjs/highlight.min.js"></script>
      
        <script src="../../../../assets/js/theme.js"></script>
      
        <script src="../../../../assets/lib/backtotop/js/util.js"></script>
      
        <script src="../../../../assets/lib/backtotop/js/main.js"></script>
      
    
  </body>
</html>